<html data-cast-api-enabled="true">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Codenames</title>

  <link rel="stylesheet" href="index.css">

</head>
<body>

<div class="wrap">

  <div id="scoreboard">
    <div class="dzeno-team teamA">
      <div class="slider">
        <div class="img">
          <img src="dzeno.png" />
        </div>
        <div class="win-track"></div>
      </div>

      <div class="score">
        <h1 class="name">Dzeno</h1>
        <div class="points">
          0
        </div>
      </div>

    </div>

    <div class="asi-team teamB">
      <div class="slider">
        <div class="img">
          <img src="asi.jpg" />
        </div>
        <div class="win-track"></div>
      </div>

      <div class="score">
        <h1 class="name">Asi</h1>
        <div class="points">
          0
        </div>
      </div>

    </div>

  </div>

  <div id="game"></div>

  <div id="controls">
    <button is="google-cast-button" class="cast-btn">
      <img src="google-cast-logo.svg" alt="cast-icon" />
    </button>
    <div class="play-btn">NEW GAME</div>
    <div class="refresh-btn">NEXT</div>
    <div class="spoiler-btn">SPOILER</div>
  </div>
  </div>

</div>

  <div class="modal">
    <div class="modal-view">
      <div class="question">Which team clicked on an assasin?</div>
      <br>
      <div class="team teamA">Team A</div>
      <div class="team teamB">Team B</div>
      <div class="clearfix"></div>
    </div>
  </div>

</body>
<script src="rijeci.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="http://underscorejs.org/underscore-min.js"></script>
<script type="text/javascript"
        src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
<script src="chromecast.js"></script>
<script type="text/javascript">
var state = {
  in_progress: false,
  first_team: '',
  words: [],
  score: [0, 0],
  board: [],
  revealed: []
}

$(document).ready(function(){

  startGame();

  $('.play-btn').on('click', function() {
    startGame();
  })

  $('.spoiler-btn').on('mouseenter mouseleave', function() {
    $('#game').toggleClass('spoiler');
  });

  $('#game').on('click', '.word', function(){
    if(state.in_progress) {
      revealWord(parseInt($(this).attr('data-index')));
    }
  });

  $('.modal').on('click', '.team', function(){
    state.score[($(this).hasClass('teamA') ? 1 : 0)]++;
    renderScore();
    $('.modal').toggleClass('modal-visible');
  });

})

function startGame() {
  state.in_progress = true;
  state.max_score = prompt('What\'s the max score');
  if(state.first_team === '') state.first_team = 'teamA';
  else state.first_team = state.first_team === 'teamA' ? 'teamB' : 'teamA';
  state.board = generateBoard(state.first_team);
  state.words = getRandomWords(rijeci, 25);
  state.revealed = [];
  render();
  cast(state);
}

function render() {
  $('#game').html('');
  $.each(state.words, function(i, word){
    var classes = state.revealed.indexOf(i) >= 0 || !state.in_progress ? 'word revealed' : 'word';
    $('#game').append('<div class="' + classes + ' ' + state.board[i] + '" data-index="' + i + '">' + word + '</div>');
  });
  $('#game').append('<div class="clearfix"></div>');
}

function renderScore() {
  $("#scoreboard .teamA .points").html(state.score[0]);
  $("#scoreboard .teamB .points").html(state.score[1]);

  $("#scoreboard .teamA .win-track").css('top', 100 - ((state.score[0] / state.max_score) * 100) + '%');
  $("#scoreboard .teamB .win-track").css('top', 100 - ((state.score[1] / state.max_score) * 100) + '%');

  $("#scoreboard .teamA .img").css('bottom', (state.score[0] / state.max_score) * 100 + '%');
  $("#scoreboard .teamB .img").css('bottom', (state.score[1] / state.max_score) * 100 + '%');
}

function generateBoard(first) {
  var teamA = first === 'teamA' ? 9 : 8;
  var teamB = first === 'teamB' ? 9 : 8;

  var board = new Array(25);
  board.fill('teamA', 0, teamA);
  board.fill('teamB', teamA, teamA+teamB);
  board.fill('neutral', teamA+teamB);
  board[board.length-1] = 'assasin';

  return shuffle(board);
}

function revealWord(index) {
  if(state.revealed.indexOf(index) < 0) {
    state.revealed.push(index);
    $('.word[data-index=' + index + ']').addClass('revealed');
    checkForWinner(index);
    cast(state);
  }
}

function checkForWinner(index) {
  var teamA = calcRemainingFields('teamA');
  var teamB = calcRemainingFields('teamB');
  var in_progress = false;

  if(teamA === 0) {
    state.score[0]++;
  } else if(teamB === 0) {
    state.score[1]++;
  } else if(state.board[index] === 'assasin') {
    $('.modal').toggleClass('modal-visible');
  } else {
    in_progress = true;
  }

  state.in_progress = in_progress;
  if(!in_progress) {
    renderScore();
    render();
  }
}

function calcRemainingFields(field_value) {
  return state.board.filter(function(field, i) { return field === field_value }).length - state.board.filter(function(field, i) { return field === field_value && state.revealed.indexOf(i) >= 0 }).length;
}

function shuffle(words) {
  var replaced = [];
  var newArray = words.slice(0);
  for(var i = 0; i < words.length; i++) {
    var newIndex;

    do {
      newIndex = getRandomInt(0, words.length-1);
    } while(replaced.indexOf(newIndex) >= 0);

    replaced.push(newIndex);
    newArray[newIndex] = words[i];
  }

  return newArray;
}

function getRandomWords(words, n) {
  var rnd;
  var results = [];
  while(results.length < n) {
    rnd = getRandomInt(0, words.length);
    if(results.indexOf(words[rnd]) === -1) {
      results.push(words[rnd]);
    }
  }
  return results;
}

function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

</script>
</html>
